<img src="https://i.imgur.com/6U6q5jQ.png"/>

# Data Aggregating in R


Sometimes, you need to summarize the unit of analysis at a higher level. This is when you need the aggregating capabilities in Pandas.

We will use data from here:


```{r}
%%html
<iframe width="700" height="300" src="https://covid.saude.gov.br/" allowfullscreen></iframe>

```

I downloaded the data for 2022 in the _FilesToAggregate_ folder:


```{r}
list_of_files <- list.files(path = "FilesToAggregate",
                            recursive = TRUE,
                            pattern = "2022.csv$",
                            full.names = TRUE)

list_of_files
```


```{r}
dfs = lapply(list_of_files, read.csv,sep=';')

covid=do.call(rbind, dfs)
dim(covid)
```

Let's check the names:


```{r}
for (df in dfs)
    print(names(df))
```

We have several rows:


```{r}
dim(covid)
```

Let's keep the columns needed:


```{r}
toSelect=c('regiao', 'estado', 'municipio','data', 'semanaEpi','casosNovos', 'obitosNovos')
covid=covid[,toSelect]
```


```{r}
# you have the data at the municipal level

head(covid)
```

We will aggregate by estado, let's check missingness:


```{r}
summary(covid)
```

There are enough data, let's see different aggregation alternatives:


```{r}
# sum of cases by estado
casesSumByState=aggregate(data=covid,casosNovos~estado,sum)
casesSumByState
```


```{r}
# sum of cases by estado and week
casesSumByStateAndWeek=aggregate(data=covid,casosNovos~estado + semanaEpi,sum)

casesSumByStateAndWeek
```


```{r}
# sum and mean of cases by estado and week

aggregate(data=covid, )
casesSumAndMeanByStateAndWeek=covid.groupby(['estado','semanaEpi']).agg({'casosNovos': ['sum','mean']})
casesSumAndMeanByStateAndWeek
```


```{r}
# sum of cases and deaths by estado
CasesAndDeathsByState=covid.groupby('estado').agg({'casosNovos': 'sum', 'obitosNovos': 'sum'})
CasesAndDeathsByState
```


```{r}
# sum and mean of cases and deaths by estado and week
CasesAndDeathsMeanAndSumByStateAndWeek=covid.groupby(['estado','semanaEpi']).agg({'casosNovos': ['sum','mean'],'obitosNovos':['sum','mean']})
CasesAndDeathsMeanAndSumByStateAndWeek
```

In all the previous cases, the aggregating category is the new index. In general, you can have a traditional table like this:


```{r}
CasesAndDeathsByState.reset_index()
```

However, in case of **multi index** that could be more challenging:


```{r}
CasesAndDeathsMeanAndSumByStateAndWeek.head()
```


```{r}
CasesAndDeathsMeanAndSumByStateAndWeek.columns
```


```{r}
newColumns=["_".join(levels) for levels in CasesAndDeathsMeanAndSumByStateAndWeek.columns]
newColumns
```


```{r}
CasesAndDeathsMeanAndSumByStateAndWeek.columns=newColumns
```


```{r}
CasesAndDeathsMeanAndSumByStateAndWeek
```


```{r}
CasesAndDeathsMeanAndSumByStateAndWeek.reset_index(inplace=True)
CasesAndDeathsMeanAndSumByStateAndWeek
```


```{r}
import os

CasesAndDeathsMeanAndSumByStateAndWeek.to_csv(os.path.join("FilesToAggregate","Aggregated_Covid.csv"),index=False)
```


```{r}

```
